generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL") // For migrations (bypasses connection pooler)
}

// API Access Tiers
enum ApiTier {
  FREE   // 100 req/min, basic endpoints
  FEEDER // 1000 req/min, auto-granted to active feeders
  PRO    // 10000 req/min, paid (future)
}

// Better Auth: User account
model user {
  id            String    @id
  email         String    @unique
  emailVerified Boolean   @default(false)
  name          String
  image         String?

  // Custom fields for ADS-B
  apiKeyHash   String?  @unique // SHA-256 hash of the API key
  apiKeyPrefix String?          // First 12 chars for display (e.g. "adsb_live_ab")
  apiTier      ApiTier  @default(FREE)

  // Better Auth relations
  sessions session[]
  accounts account[]

  // ADS-B relations
  feeders Feeder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Better Auth: Session
model session {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?

  user user @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Better Auth: Account (for OAuth providers)
model account {
  id                    String    @id
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?   // For email/password auth

  user user @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Better Auth: Verification (email verification, password reset)
model verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Feeder (Pi that sends ADS-B data)
model Feeder {
  id             String  @id @default(cuid())
  uuid           String  @unique // Beast feeder UUID
  name           String
  latitude       Float?
  longitude      Float?
  heartbeatToken String? @unique // Token for authenticating heartbeat requests (generated during enrollment)
  softwareType   String? // Detected software: ultrafeeder, piaware, fr24, readsb, dump1090-fa, dump1090-mutability

  // Enrollment token for initial setup (short-lived, single-use)
  enrollmentToken   String?   @unique // Random hex token for first-time enrollment
  enrollmentExpires DateTime?          // Expires 1 hour after creation

  // Owner
  userId String
  user   user   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stats (updated periodically)
  messagesTotal  BigInt   @default(0)
  positionsTotal BigInt   @default(0)
  aircraftSeen   Int      @default(0)
  lastSeen       DateTime?
  isOnline       Boolean  @default(false)

  // Range tracking (updated during heartbeat)
  maxRangeNm     Float?   // Maximum range ever seen (nautical miles)
  avgRangeNm24h  Float?   // Rolling 24-hour average range

  // Scoring (updated hourly by stats-worker)
  currentScore   Int      @default(0) // 0-100 composite score

  // Rank tracking (for change indicators)
  previousRank   Int?
  currentRank    Int?

  // Historical stats
  stats FeederStats[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isOnline])
}

// Historical feeder statistics (hourly snapshots)
model FeederStats {
  id       String @id @default(cuid())
  feederId String
  feeder   Feeder @relation(fields: [feederId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())
  messages  Int      // Messages in this period
  positions Int      // Positions in this period
  aircraft  Int      // Unique aircraft seen

  // Phase 7: Range and scoring metrics
  maxRange      Float?  // Max range this hour (nm)
  avgRange      Float?  // Average range this hour (nm)
  score         Int?    // Composite score (0-100)
  uptimePercent Float?  // Uptime percentage (0-100)
  messageRate   Float?  // Messages per minute
  positionRate  Float?  // Positions per minute

  @@index([feederId, timestamp])
  @@index([timestamp])
}

// Historical aircraft positions (snapshots every ~10 seconds)
model AircraftPosition {
  id        String   @id @default(cuid())
  hex       String   // ICAO hex address
  lat       Float
  lon       Float
  altitude  Int?     // Barometric altitude in feet
  heading   Float?   // Track angle in degrees
  speed     Float?   // Ground speed in knots
  squawk    String?  // Squawk code
  flight    String?  // Callsign
  timestamp DateTime @default(now())

  @@index([timestamp])
  @@index([hex, timestamp])
  @@index([flight, timestamp]) // Enable callsign-based queries
}

// Archived flight records with embedded position data
model Flight {
  id            String   @id @default(cuid())
  hex           String   // ICAO hex address
  callsign      String?  // Callsign at time of flight
  startTime     DateTime
  endTime       DateTime
  maxAltitude   Int?     // Max altitude in feet
  totalDistance Float?   // Distance in nautical miles
  durationSecs  Int      // Duration in seconds
  positionCount Int      // Number of archived positions
  startLat      Float
  startLon      Float
  endLat        Float
  endLon        Float

  // Archived positions (JSON array, downsampled to ~30s intervals)
  // Format: [{lat, lon, alt, hdg, spd, ts}, ...]
  positions     Json

  segmentedAt   DateTime @default(now())

  @@index([hex])
  @@index([callsign])
  @@index([startTime])
  @@index([hex, startTime])
}

// Future: Stripe subscription for Pro tier
model Subscription {
  id               String    @id @default(cuid())
  userId           String    @unique
  stripeCustomerId String?
  stripePriceId    String?
  status           String    // active, canceled, past_due
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}
